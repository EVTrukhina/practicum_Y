# Задача

Спроектировать и задокументировать API в Swagger для новой фичи на основе анализа архитектуры (C4) и макета.

# Процесс работы

## Архитектура приложения и модель С4

Проведен анализ [расшифровки встречи с архитектором](https://docs.google.com/document/d/1E1FYjQ4kXn_VuqZVjIv0X3Ml3IWQyWHXB57RJsv5UsM/edit?usp=sharing). На основании анализа доработана контекстная диаграмма C4, описывающая архитектуру приложения LUCKY.

Дополнения к диаграмме:

*   **Описания компонентов:** Добавлены описания каждого ключевого компонента (Mobile App, API Gateway, Load Balancer, AuthServer, Shopping Cart, Payment, Shipping, внешние системы Система PAY-PAY, Система SHIP-SHIP, и др.), что позволяет понять их назначение в системе.
*   **Протоколы взаимодействия:** Указаны протоколы взаимодействия между компонентами (REST, TCP, SFTP, QUERY), что облегчает понимание потоков данных и связности системы.


![Обновленная диаграмма UML](https://github.com/EVTrukhina/practicum_Y/blob/main/Модель%20С4%20диаграмма%20для%20LUCKY.png)
<p align="center">Рис 1. Модель С4 </p>

**1. Архитектурные паттерны:**

*   **Database per service:** Каждый микросервис имеет собственную базу данных, доступ к которой осуществляется исключительно через API сервиса. Это обеспечивает независимость и автономность микросервисов, избегая общей базы данных.
*   **Server-side discovery:** Приложение использует Service Registry и Load Balancer на стороне сервера для динамического обнаружения сервисов и распределения нагрузки. Load Balancer располагается на стороне сервера, что соответствует архитектурному паттерну.

**2. Компоненты и взаимодействие:**

*   **Микросервисная архитектура:** Система состоит из 7 микросервисов: User, Store, Shopping Cart, Films, Insurance, Shipping, Payment.
*   **Внешние системы:** Для полноценной работы приложения LUCKY необходимы 4 внешние системы:
    *   **PAY-PAY:** Проведение платежей.
    *   **SHIP-SHIP:** Оформление доставки.
    *   **CRM:** Обработка заказов оператором.
    *   **Amazon S3:** Хранение медиафайлов.
*   **Взаимодействие с Kafka:** Новый сервис взаимодействует с сервисом Shopping Cart через Kafka.

**3. Kafka: Асинхронный брокер сообщений:** 

На C4-диаграмме использование Kafka представлено как TCP-соединение между Load Balancer, Kafka и Shopping Cart. Взаимодействие между этими компонентами асинхронное: они обмениваются сообщениями через Kafka, выступающую в роли брокера. Это позволяет сервисам работать независимо и повышает отказоустойчивость системы.

**Примеры использования Kafka в LUCKY:**

*   Когда пользователь добавляет товар в корзину, новый сервис отправляет сообщение в Kafka, которое обрабатывается сервисом Shopping Cart. Это позволяет асинхронно обновить состав корзины пользователя.

*   Когда пользователь оформляет заказ, сервис Shopping Cart отправляет сообщение в Kafka, которое обрабатывается сервисами Payment и Shipping.



## Проектирование API

**Задача:** Спроектировать API для нового раздела «Страхование домашних животных» в приложении LUCKY, позволяющего пользователям просматривать описание страховок для котов и собак.

<details>
  <summary>Допущения</summary>
  <ul>
    <li>Функциональность добавления товара в корзину и оплаты уже реализована и не требует проектирования.</li>
    <li>На текущий момент доступны страховки для котов и собак, с возможностью добавления других видов животных в будущем.</li>
    <li>Пользователь заказывает услугу страхования в приложении, детали (информация о животном) предоставляются позже, при оформлении документов.</li>
  </ul>
</details>

![Обновленная диаграмма UML](https://github.com/EVTrukhina/practicum_Y/blob/main/Макет%20LUCKY.png)

### Моделирование профиля API

**Определение цифровых возможностей. Дополненная история пользователя (Job Story):**

*   *Когда у меня* активный и любопытный питомец,
*   *Я хочу* оформить страховку для домашнего животного,
*   *Чтобы* получать помощь в рамках страховой программы.

**Определение действий и их шагов:**

| Цифровая возможность | Действие                    | Шаг действия                  | Участник   | Описание                                                                 |
|-----------------------|---------------------------|-------------------------------|------------|---------------------------------------------------------------------------|
| Оформить страховку    | Ознакомиться со страховками | Ознакомиться со страховками    | Пользователь | Получить информацию обо всех страховках                                     |
| Оформить страховку    | Положить страховку в корзину | Добавить страховку в корзину  | Пользователь | Добавить страховку в корзину                                              |
| Оформить страховку    | Оплатить страховку         | Оплатить страховку             | Пользователь | Оплатить выбранные товары в корзине с помощью интернет-эквайринга        |

**Определение границ API. Группировка действий и шагов:**

| Цифровая возможность | Действие                    | Шаг действия                  | Участник   | Описание                                                                 |
|-----------------------|---------------------------|-------------------------------|------------|---------------------------------------------------------------------------|
| Оформить страховку    | Ознакомиться со страховками | Ознакомиться со страховками    | Пользователь | Получить информацию обо всех страховках                                     |
| Оформить страховку    | Положить страховку в корзину | Добавить страховку в корзину  | Пользователь | Добавить страховку в корзину                                              |
| Оформить страховку    | Оплатить страховку         | Оплатить страховку             | Пользователь | Оплатить выбранные товары в корзине с помощью интернет-эквайринга        |

**Моделирование профилей API. Описание функциональных возможностей (операций):**

| Название операции | Описание операции                        | Участники   | Ресурсы    | Детали операции                                                                                                                                                                                              |
|-------------------|-------------------------------------------|------------|------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `получитьСтраховки()` | Получить информацию обо всех страховках | Пользователь | Страховка  | Параметры запроса: Отсутствует. <br> Возвращает ресурс: Страховка. <br> Возвращает ответ:  <ul><li>описаниеСтраховки</li><li>ценаСтраховки</li><li>типЖивотного</li><li>периодСтрахования</li></ul> <br> Безопасная / синхронная |


**Высокоуровневое проектирование API:**

*   Тип API: Внутренний, REST API
*   Формат данных: JSON


## Документирование API на YAML

Cоздала документацию API в Swagger на основании описанного профиля.

```yaml
openapi: 3.0.0
info:
  title: API сервиса Lucky Insuranc
  description: |
    Коллекция запросов API сервиса. Сервис предоставляет информацию об страховках для животных
  version: 1.0.1
  contact:
    name: LuckyFilms API
    url: https://lucky.com/info
    email: LuckyFilms@lucky.com
  termsOfService: https://lucky.com/terms
  license:
    name: license 1.0.1 Lucky
    url: https://lucky.com/license
servers:
  - url: https://4453f729-1913-49be-9dcc-b7a316afa17f.mock.pstmn.io
    description: string
tags:
  - name: Insurance Server API
paths:
  /insurance:
    get:
      tags:
        - Insurance Server API
      summary: Описание всех страховок для животных
      description: Помощь ветеринара 24/7. Онлайн консультации. Большой выбор ветклиник.
      operationId: insuranceList
      responses:
        '200':
          description: список страховок
          # дальше заполните пропуски там, где это необходимо
          content:
            application/json:
              schema:
                type: object
                properties:
                  description:
                    type: string
                    description: string
                    example: Помощь ветеринара 24/7. Онлайн консультации. Большой выбор ветклиник.
                  insurances:
                    type: array 
                    items:
                      $ref: '#/components/schemas/response_200'
        '400':
          description: Неверный запрос - Некорректные входные данные.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Некорректные параметры запроса
        '500':
          description: Внутренняя ошибка сервера.
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Внутренняя ошибка сервера
components:
  schemas:
    response_200:
      required:
        - type
        - details
        - price
        - currency
        - period
      type: object
      properties:
        type: 
          type: string
          description: Тип животного
          example: кошка
        details:
          type: string
          description: Описание страховки 
          example: Круглосуточные консультации ветеринарного врача по телефону, в чате или видеосвязи. Включена ежегодная вакцинация от бешенства.
        price:
          type: integer
          description: Цена страховки 
          example: 50000
        currency:
          type: string 
          description: Цена в рублях
          example: рублей
        period:
          type: string 
          description: Период страхования
          example: в год

```

[Назад](https://github.com/EVTrukhina/practicum_Y/blob/main/task_1.md) | [Дальше](https://github.com/EVTrukhina/practicum_Y/blob/main/task_3.md) 

